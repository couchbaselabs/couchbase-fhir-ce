# FHIR Bucket Configuration
# This file defines the structure for converting a Couchbase bucket to FHIR-enabled
# Including scopes, collections, and indexes for each collection

fhir:
  scopes:
    admin:
      name: "Admin"
      description: "Administrative and metadata collections for FHIR server"
      collections:
        - name: "config"
          description: "Tenant configuration, feature flags"
          indexes:
            - name: "PRIMARY"
              type: "primary"
              sql: "CREATE PRIMARY INDEX ON `{bucket}`.`Admin`.`config` WITH {'defer_build': true}"

        - name: "users"
          description: "User management, authentication"
          indexes:
            - name: "PRIMARY"
              type: "primary"
              sql: "CREATE PRIMARY INDEX ON `{bucket}`.`Admin`.`users` WITH {'defer_build': true}"

    resources:
      name: "Resources"
      description: "FHIR clinical and administrative resource collections"
      collections:
        - name: "Patient"
          description: "Patient - 1 resource"
          indexes:

        - name: "Observation"
          description: "Observation - 1 resource"
          indexes:

        - name: "Encounter"
          description: "Encounter - 1 resource"
          indexes:

        - name: "Condition"
          description: "Condition - 1 resource"
          indexes:

        - name: "Procedure"
          description: "Procedure - 1 resource"
          indexes:

        - name: "MedicationRequest"
          description: "MedicationRequest - 1 resource"
          indexes:

        - name: "DiagnosticReport"
          description: "DiagnosticReport - 1 resource"
          indexes:

        - name: "DocumentReference"
          description: "DocumentReference - 1 resource"
          indexes:

        - name: "Immunization"
          description: "Immunization - 1 resource"
          indexes:

        - name: "General"
          description: "All other resources"
          indexes:

        - name: "Versions"
          description: "FHIR Versions resources"
          indexes:

        - name: "Tombstones"
          description: "FHIR Tombstones resources"
          indexes:

  build_commands:
    - name: "Build Deferred Indexes"
      description: "Finds all deferred indexes and generates BUILD INDEX statements to run."
      query: |
        SELECT RAW CONCAT("BUILD INDEX ON ", k ,  "(['", CONCAT2 ("','", inames), "']);")
        FROM system:indexes AS s
        LET bid = CONCAT("`",s.bucket_id, "`"),
            sid = CONCAT("`", s.scope_id, "`"),
            kid = CONCAT("`", s.keyspace_id, "`"),
            k = NVL2(bid, CONCAT2(".", bid, sid, kid), kid)
        WHERE s.namespace_id = "default"
        GROUP BY k
        LETTING inames = ARRAY_AGG(s.name) FILTER (WHERE s.state = 'deferred')
        HAVING ARRAY_LENGTH(inames) > 0

# FHIR Resource to Collection Mapping Configuration
mapping:
  resource_to_collection:
    # Dedicated collections for high-volume/important resources
    Patient: Patient
    Observation: Observation
    Encounter: Encounter
    Condition: Condition
    Procedure: Procedure
    MedicationRequest: MedicationRequest
    DiagnosticReport: DiagnosticReport
    DocumentReference: DocumentReference
    Immunization: Immunization

    # Default fallback - any resource not explicitly listed above goes to General collection
    _default: General

  collection_to_fts_index:
    Patient: ftsPatient
    Observation: ftsObservation
    Encounter: ftsEncounter
    Condition: ftsCondition
    Procedure: ftsProcedure
    MedicationRequest: ftsMedicationRequest
    DiagnosticReport: ftsDiagnosticReport
    DocumentReference: ftsDocumentReference
    Immunization: ftsImmunization
    General: ftsGeneral
    Versions: ftsVersions
