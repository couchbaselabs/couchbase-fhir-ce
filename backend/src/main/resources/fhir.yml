# FHIR Bucket Configuration
# This file defines the structure for converting a Couchbase bucket to FHIR-enabled
# Including scopes, collections, and indexes for each collection

fhir:
  scopes:
    admin:
      name: "Admin"
      description: "Administrative and metadata collections for FHIR server"
      collections:
        - name: "config"
          description: "Tenant configuration, feature flags"
          indexes:
            - name: "PRIMARY"
              type: "primary"
              sql: "CREATE PRIMARY INDEX ON `{bucket}`.`Admin`.`config` WITH {'defer_build': true}"

        - name: "users"
          description: "User management, authentication"
          indexes:
            - name: "PRIMARY"
              type: "primary"
              sql: "CREATE PRIMARY INDEX ON `{bucket}`.`Admin`.`users` WITH {'defer_build': true}"

    resources:
      name: "Resources"
      description: "FHIR clinical and administrative resource collections"
      collections:
        - name: "BaseEntities"
          description: "Base Entities (Organizations, Locations, Devices) - 9 resources"
          indexes:

        - name: "BaseIndividuals"
          description: "Base Individuals (People & Roles) - 6 resources"
          indexes:

        - name: "BaseManagement"
          description: "Base Management (Encounters & Workflow) - 18 resources"
          indexes:

        - name: "ClinicalSummary"
          description: "Clinical Summary (Conditions & History) - 14 resources"
          indexes:

        - name: "ClinicalDiagnostics"
          description: "Clinical Diagnostics (Tests, Results, Reports) - 16 resources"
          indexes:

        - name: "ClinicalCare"
          description: "Clinical Care (Care Planning & Services) - 11 resources"
          indexes:

        - name: "ClinicalMedications"
          description: "Clinical Medications (Drugs & Immunizations) - 10 resources"
          indexes:

        - name: "Financial"
          description: "Financial (Billing, Coverage, Claims) - 16 resources"
          indexes:

        - name: "Versions"
          description: "FHIR Versions resources"
          indexes:

        - name: "Tombstones"
          description: "FHIR Tombstones resources"
          indexes:

  build_commands:
    - name: "Build Deferred Indexes"
      description: "Finds all deferred indexes and generates BUILD INDEX statements to run."
      query: |
        SELECT RAW CONCAT("BUILD INDEX ON ", k ,  "(['", CONCAT2 ("','", inames), "']);")
        FROM system:indexes AS s
        LET bid = CONCAT("`",s.bucket_id, "`"),
            sid = CONCAT("`", s.scope_id, "`"),
            kid = CONCAT("`", s.keyspace_id, "`"),
            k = NVL2(bid, CONCAT2(".", bid, sid, kid), kid)
        WHERE s.namespace_id = "default"
        GROUP BY k
        LETTING inames = ARRAY_AGG(s.name) FILTER (WHERE s.state = 'deferred')
        HAVING ARRAY_LENGTH(inames) > 0

# FHIR Resource to Collection Mapping Configuration
mapping:
  resource_to_collection:
    # Base Individuals (People & Roles) - 6 resources
    Patient: BaseIndividuals
    Practitioner: BaseIndividuals
    PractitionerRole: BaseIndividuals
    RelatedPerson: BaseIndividuals
    Person: BaseIndividuals
    Group: BaseIndividuals

    # Base Entities (Organizations, Locations, Devices) - 9 resources
    Organization: BaseEntities
    Location: BaseEntities
    Device: BaseEntities
    DeviceDefinition: BaseEntities
    DeviceMetric: BaseEntities
    DeviceRequest: BaseEntities
    DeviceUseStatement: BaseEntities
    HealthcareService: BaseEntities
    Endpoint: BaseEntities

    # Base Management (Encounters & Workflow) - 18 resources
    Encounter: BaseManagement
    EpisodeOfCare: BaseManagement
    Flag: BaseManagement
    List: BaseManagement
    Appointment: BaseManagement
    AppointmentResponse: BaseManagement
    Schedule: BaseManagement
    Slot: BaseManagement
    Task: BaseManagement
    Communication: BaseManagement
    CommunicationRequest: BaseManagement
    MessageHeader: BaseManagement
    MessageDefinition: BaseManagement
    Subscription: BaseManagement
    SupplyRequest: BaseManagement
    SupplyDelivery: BaseManagement
    CatalogEntry: BaseManagement
    Basic: BaseManagement

    # Clinical Summary (Conditions & History) - 14 resources
    AllergyIntolerance: ClinicalSummary
    Condition: ClinicalSummary
    Procedure: ClinicalSummary
    FamilyMemberHistory: ClinicalSummary
    ClinicalImpression: ClinicalSummary
    DetectedIssue: ClinicalSummary
    RiskAssessment: ClinicalSummary
    AdverseEvent: ClinicalSummary
    BodyStructure: ClinicalSummary
    ImagingStudy: ClinicalSummary
    MolecularSequence: ClinicalSummary
    ResearchSubject: ClinicalSummary
    ResearchStudy: ClinicalSummary
    GuidanceResponse: ClinicalSummary

    # Clinical Diagnostics (Tests, Results, Reports) - 16 resources
    Observation: ClinicalDiagnostics
    DiagnosticReport: ClinicalDiagnostics
    Specimen: ClinicalDiagnostics
    SpecimenDefinition: ClinicalDiagnostics
    QuestionnaireResponse: ClinicalDiagnostics
    Questionnaire: ClinicalDiagnostics
    DocumentReference: ClinicalDiagnostics
    DocumentManifest: ClinicalDiagnostics
    Media: ClinicalDiagnostics
    Binary: ClinicalDiagnostics
    Bundle: ClinicalDiagnostics
    Composition: ClinicalDiagnostics
    Contract: ClinicalDiagnostics
    Consent: ClinicalDiagnostics
    Provenance: ClinicalDiagnostics
    AuditEvent: ClinicalDiagnostics

    # Clinical Medications (Drugs & Immunizations) - 10 resources
    MedicationRequest: ClinicalMedications
    MedicationDispense: ClinicalMedications
    MedicationAdministration: ClinicalMedications
    MedicationStatement: ClinicalMedications
    Medication: ClinicalMedications
    MedicationKnowledge: ClinicalMedications
    Immunization: ClinicalMedications
    ImmunizationEvaluation: ClinicalMedications
    ImmunizationRecommendation: ClinicalMedications
    BiologicallyDerivedProduct: ClinicalMedications

    # Clinical Care (Care Planning & Services) - 11 resources
    CarePlan: ClinicalCare
    CareTeam: ClinicalCare
    Goal: ClinicalCare
    ServiceRequest: ClinicalCare
    NutritionOrder: ClinicalCare
    VisionPrescription: ClinicalCare
    RequestGroup: ClinicalCare
    ActivityDefinition: ClinicalCare
    PlanDefinition: ClinicalCare
    Measure: ClinicalCare
    MeasureReport: ClinicalCare

    # Financial (Billing, Coverage, Claims) - 16 resources
    Coverage: Financial
    CoverageEligibilityRequest: Financial
    CoverageEligibilityResponse: Financial
    EnrollmentRequest: Financial
    EnrollmentResponse: Financial
    Claim: Financial
    ClaimResponse: Financial
    Invoice: Financial
    PaymentNotice: Financial
    PaymentReconciliation: Financial
    Account: Financial
    ChargeItem: Financial
    ChargeItemDefinition: Financial
    InsurancePlan: Financial
    ExplanationOfBenefit: Financial
    VerificationResult: Financial

    # Additional Foundation & Infrastructure Resources (46 more)
    # These could be distributed across collections or kept separate

    # Terminology & Knowledge Resources - Could go in BaseManagement
    ConceptMap: BaseManagement
    ValueSet: BaseManagement
    CodeSystem: BaseManagement
    NamingSystem: BaseManagement
    TerminologyCapabilities: BaseManagement

    # Structure & Conformance - Could go in BaseManagement
    StructureDefinition: BaseManagement
    StructureMap: BaseManagement
    ImplementationGuide: BaseManagement
    CapabilityStatement: BaseManagement
    OperationDefinition: BaseManagement
    SearchParameter: BaseManagement
    CompartmentDefinition: BaseManagement
    GraphDefinition: BaseManagement

    # Testing & Quality - Could go in ClinicalCare
    TestScript: ClinicalCare
    TestReport: ClinicalCare

    # Libraries & Logic - Could go in ClinicalCare
    Library: ClinicalCare
    EventDefinition: ClinicalCare

    # Research & Evidence - Could go in ClinicalSummary
    Evidence: ClinicalSummary
    EvidenceVariable: ClinicalSummary
    EffectEvidenceSynthesis: ClinicalSummary
    RiskEvidenceSynthesis: ClinicalSummary

    # Operations & Parameters - Could go in BaseManagement
    Parameters: BaseManagement
    OperationOutcome: BaseManagement

    # Linkage & Relationships - Could go in BaseManagement
    Linkage: BaseManagement

    # Substance & Materials - Could go in ClinicalMedications
    Substance: ClinicalMedications
    SubstanceSpecification: ClinicalMedications
    SubstancePolymer: ClinicalMedications
    SubstanceReferenceInformation: ClinicalMedications
    SubstanceSourceMaterial: ClinicalMedications
    SubstanceProtein: ClinicalMedications
    SubstanceNucleicAcid: ClinicalMedications

    # Regulatory & Manufacturing - Could go in ClinicalMedications
    MedicinalProduct: ClinicalMedications
    MedicinalProductAuthorization: ClinicalMedications
    MedicinalProductContraindication: ClinicalMedications
    MedicinalProductIndication: ClinicalMedications
    MedicinalProductIngredient: ClinicalMedications
    MedicinalProductInteraction: ClinicalMedications
    MedicinalProductManufactured: ClinicalMedications
    MedicinalProductPackaged: ClinicalMedications
    MedicinalProductPharmaceutical: ClinicalMedications
    MedicinalProductUndesirableEffect: ClinicalMedications

    # Marketing & Manufacturing - Could go in BaseEntities
    MarketingStatus: BaseEntities
    ProductShelfLife: BaseEntities
    ProdCharacteristic: BaseEntities

  collection_to_fts_index:
    BaseIndividuals: ftsBaseIndividuals
    BaseEntities: ftsBaseEntities
    BaseManagement: ftsBaseManagement
    ClinicalSummary: ftsClinicalSummary
    ClinicalDiagnostics: ftsClinicalDiagnostics
    ClinicalMedications: ftsClinicalMedications
    ClinicalCare: ftsClinicalCare
    Financial: ftsFinancial
